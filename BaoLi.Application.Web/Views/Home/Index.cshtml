@{
    ViewBag.Title = "首页";
    Layout = "~/Views/Shared/_Index.cshtml";
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <script src="~/Content/scripts/utils/echarts.js"></script>
    <title>我的桌面</title>
</head>

<body>
    <div class="ecommerce-cont">
        <div>
            <table class="searchTable">
                <tr>
                    <th class="formTitle" style="font-weight:bolder">年份:</th>
                    <td class="formValue">
                        <div id="Year" type="select" class="ui-select">
                        </div>
                    </td>
                    <th class="formTitle" style="font-weight:bolder">所属区域公司:</th>
                    <td class="formValue">
                        <div id="Project_Id" type="select" class="ui-select">
                        </div>
                    </td>
                    <th class="formTitle" style="font-weight:bolder">所属项目:</th>
                    <td class="formValue">
                        <div id="Project_Name" type="select" class="ui-select">
                        </div>
                    </td>

                </tr>
            </table>
        </div>
        <div class="t-row">
            <div class="col-4">
                <div class="cardCont">
                    <div class="colorNum fontGreen" id="ControlTotalAmount" moneyformat="F"></div>
                    <div class="cardTxt">我司可支配总金额(元)</div>
                </div>
            </div>
            <div class="col-4">
                <div class="cardCont">
                    <div class="colorNum fontYellow" id="FlowNopayTotalAmount" moneyformat="F"></div>
                    <div class="cardTxt">流程中未付款金额(元)</div>
                </div>
            </div>
            <div class="col-4">
                <div class="cardCont">
                    <div class="colorNum fontBrown" id="ActualControlTotalAmount" moneyformat="F"></div>
                    <div class="cardTxt">实际我司可支配总金额(元)<span>（扣除流程中未付款）</span></div>
                </div>
            </div>
        </div>
        <div class="t-row">
            <div class="col-5">
                <div class="cardCont noRadius" style=" height: 500px;">
                    <div class="cardCont-title">电商资金占比</div>
                    <div id="PayListShow" style=" height: 400px;"></div>
                </div>
            </div>

            <div class="col-7">
                <div class="cardCont noRadius" style=" height: 500px;">
                    <div class="cardCont-title">电商资金流动走势图</div>
                    <div id="LineShow" style=" height: 400px;"></div>
                </div>

            </div>
        </div>
    </div>
    @*<button onclick="testPop()">Test PopUp</button>*@
    <script>

        $(function () {

            query();
            clickquery();

        });
        function query() {
            $("#Year").ComboBox({
                url: "../../CapitalFlowManage/T_CapitalFlow/GetYear",
                id: "value",
                text: "id",
                height: "180px",
                allowSearch: true,
            }).bind("change", function () {
                clickquery();
            });
            var year = new Date().getFullYear();

            $("#Year").ComboBoxSetValue(year);
            //区域公司
            $("#Project_Id").ComboBox({
                url: "../../BaseManage/Department/GetListByAuthorize",
                id: "DepartmentId",
                text: "FullName",
                description: "==请选择==",
                height: "200px",
                allowSearch: true,
            }).bind("change", function () {
                var value = $(this).attr("data-value");
                //项目名称
                $("#Project_Name").ComboBox({
                    url: "../../BaseManage/Base_ProjectInfo/GetProjectListByRole",
                    param: { keyValue: value },
                    id: "ProjectID",
                    text: "ProjecName",
                    description: "==请选择==",
                    height: "200px",

                });
                clickquery();
            });
            $("#Project_Name").ComboBox({
                url: "../../BaseManage/Base_ProjectInfo/GetProjectListByRole",
                description: "==请选择==",
                id: "ProjectID",
                text: "ProjecName",
                height: "180px",
                allowSearch: true,
            }).bind("change", function () {
                clickquery();
            });
        }
        function clickquery() {
            var queryJson =
                {
                    loaclyear: $("#Year").attr("data-text"),
                    companyid: $("#Project_Id").attr("data-value"),
                    projectid: $("#Project_Name").attr("data-value"),
                };
            $.GetAjax({
                loading: "正在加载查询条件...",
                url: "../../CapitalFlowManage/T_Funds_Details/GetFundStaticJson?queryJson=" + JSON.stringify(queryJson),
                success: function (data) {
                    console.log(data);
                    $("#ControlTotalAmount").text(number_format(data.ControlTotalAmount, 2, ".", ","));
                    $("#FlowNopayTotalAmount").text(number_format(data.FlowNopayTotalAmount,2,".",","));
                    $("#ActualControlTotalAmount").text(number_format(data.ActualControlTotalAmount, 2, ".", ","));
                    //$(".ecommerce-cont").SetWebControls(data);
                }
            });
            PayListShow();
            LineShow();


        }
        function testPop() {
            dialogOpen({
                id: "MessageCenter",
                title: '消息中心',
                url: '/Home/MessageIndex',
                width: "700px",
                height: "630px",
                btn: null
            });
        };

        function PayListShow() {

            var queryJson =
                  {
                      loaclyear: $("#Year").attr("data-text"),
                      companyid: $("#Project_Id").attr("data-value"),
                      projectid: $("#Project_Name").attr("data-value"),
                  };
            // 基于准备好的dom，初始化echarts实例
            var myChart = echarts.init(document.getElementById('PayListShow'));

            // 指定图表的配置项和数据
            var option = {

                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b} : {c} (元)"
                },
                legend: {
                    type: 'scroll',
                    bottom: 5,
                    x: 'right',
                    bottom: "bottom",                              //组件离容器下侧的距离,'20%'
                    width: "auto",                               //图例宽度
                    height: "auto",
                    data: []
                },
                series: [
                    {
                        name: '访问来源',
                        type: 'pie',
                        radius: '60%',
                        center: ['50%', '40%'],
                        data: [],
                        itemStyle: {
                            normal: {
                                label: {
                                    show: true,
                                    formatter: '{b} : ({d}%)'
                                },
                                labelLine: { show: true }
                            },
                            emphasis: {

                                label: {
                                    show: true,
                                    formatter: "{b}\({d}%)",
                                    position: 'center'
                                }
                            }
                        },
                    }
                ]
            };
            // 使用刚指定的配置项和数据显示图表。
            myChart.setOption(option);
            var areas = [];    //地区数组（实际用来盛放X轴坐标值）
            var brower = [];    //合作次数数组（实际用来盛放Y坐标值）
            //获取合作次数最多的
            $.GetAjax({
                url: "../../CapitalFlowManage/T_Funds_Details/GetPieDataList?queryJson=" + JSON.stringify(queryJson),
                dataType: "json",
                async: true,
                success: function (result) {
                    if (result) {
                        for (var i = 0; i < result.length; i++) {
                            var ActualControlTotalAmount = money_format(result[i].ActualControlTotalAmount, "F", 2, false)
                            areas.push(result[i].EcommerceGroupName);    //挨个取出类别并填入类别数组
                            brower.push({
                                value: ActualControlTotalAmount,
                                name: result[i].EcommerceGroupName
                            });//挨个取出销量并填入销量数组
                        }
                        myChart.setOption({        //加载数据图表
                            legend: {
                                data: areas
                            },
                            series: {
                                data: brower
                            }
                        });

                    }
                }
            });


        }
        function LineShow() {
            var queryJson =
                {
                    loaclyear: $("#Year").attr("data-text"),
                    companyid: $("#Project_Id").attr("data-value"),
                    projectid: $("#Project_Name").attr("data-value"),
                };
            var myChart = echarts.init(document.getElementById('LineShow'));
            option = {
                tooltip: {

                    trigger: 'axis'

                },

                legend: {

                    data: ['流入', '支出']

                },



                calculable: true,

                xAxis: [

                    {

                        type: 'category',

                        boundaryGap: false,

                        data: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']


                    }

                ],

                yAxis: [

                    {

                        type: 'value',
                        axisLabel: { formatter: '{value} 万' }

                    }

                ],

                series: [

                    {

                        name: '流入',

                        type: 'line',

                        stack: '总量1',
                        itemStyle: { normal: { label: { show: true } } },

                        data: []

                    },

                    {

                        name: '支出',

                        type: 'line',

                        stack: '总量2',
                        itemStyle: { normal: { label: { show: true } } },

                        data: []

                    }

                ]

            };

            myChart.setOption(option);

            var series1 = [];  //地区数组（实际用来盛放X轴坐标值）
            var series2 = [];    //合作次数数组（实际用来盛放Y坐标值）
            //获取合作次数最多的
            $.GetAjax({
                url: "../../CapitalFlowManage/T_Funds_Details/GetLineDataList?queryJson=" + JSON.stringify(queryJson),
                dataType: "json",
                async: true,
                success: function (result) {
                    if (result) {
                        for (var i = 0; i < result.length; i++) {
                            //挨个取出类别并填入类别数组
                            var CurrentBalance = money_format(result[i].CurrentBalance, "Y->M", 2, false)
                            if (result[i].AccountingType == 0) {
                                series1.push(CurrentBalance)
                                //挨个取出销量并填入销量数组
                            } else {
                                series2.push(CurrentBalance);//挨个取出销量并填入销量数组
                            }

                        }
                        myChart.setOption({
                            series:
                                 [{
                                     data: series1
                                 },
                                {
                                    data: series2
                                }]
                        });

                    }
                }
            });
        }
    </script>
</body>
</html>
